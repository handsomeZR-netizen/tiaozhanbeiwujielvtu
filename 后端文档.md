# 后端优化文档（挑战杯宣传版）

## 1. 背景与目标
本项目为挑战杯宣传型应用，允许部分功能采用假数据或模拟结果，以降低研发成本并快速完成演示。后端目标：为前端提供稳定接口、可替换的 AI 能力入口、基础内容管理与地图能力。

## 2. 约束与原则
- 分享功能可伪造：仅返回静态分享卡片配置或占位数据即可。
- 场景数据可模拟：社区流、地图推荐、文化解码等可使用固定样本。
- 统一开关：通过 `MOCK_MODE=true` 切换真实/模拟服务。
- 安全：所有第三方 API Key 仅存后端环境变量，不下发前端。

## 3. 目标接口范围（最小可用）
- 用户档案：`POST /users/profile`、`GET /users/me`
- 旅途日记：`POST /diaries`、`GET /diaries`
- 地图服务：`GET /map/poi`、`GET /map/route`、`GET /map/weather`、`GET /map/geocode`
- AI 流水线：`POST /ai/scene`、`POST /ai/context`、`POST /ai/image`、`POST /ai/tags`
- 社区：`GET /community/feed`、`POST /community/posts`
- 分享（可假）：`POST /share`
- 审核（可假）：`POST /moderation`

## 4. Codex 可执行分步计划
每一步都是可执行的子任务，完成后可单独验收。

### Step 1：搭建后端工程骨架
- 新增 `server/`，Node.js + TypeScript + Fastify（或 Express）。
- 添加基础中间件：日志、错误处理、CORS、限流。
- 提供 `GET /health` 与统一响应结构。
- 产出：`server/src/app.ts`、`server/src/routes/*`。
- 验收：启动后访问 `/health` 返回 `{ ok: true }`。

### Step 2：Mock 数据与开关
- 新增 `server/src/mocks/`，保存社区流、地图推荐、文化解码样本。
- 增加 `MOCK_MODE` 开关（读取 `.env.server`）。
- 分享接口固定返回分享卡片 JSON（标题/描述/封面/二维码占位）。
- 验收：`MOCK_MODE=true` 下接口能返回稳定样本。

### Step 3：核心接口实现（无数据库版）
- 用户档案与日记使用内存存储或本地 JSON（便于演示）。
- 社区流与地图推荐使用 Mock 数据。
- AI 接口返回可用占位结构（模拟生成结果与状态）。
- 验收：前端页面可完成演示流程。

### Step 4：第三方服务接入（可选，按需）
- 高德 Web 服务 API（POI/路线/天气/地理编码）。
- 文本生成/翻译（DeepSeek 或替代）。
- 图像/视频生成（doubao 示例）。
- 要求：通过 `MOCK_MODE` 控制真实调用与模拟返回。

### Step 5：文档与接口对齐
- 生成 OpenAPI 或 Markdown API 文档。
- 补充 `.env.server` 与 `server/.env.example`。
- 与前端约定字段：坐标、标签、媒体地址、任务状态等。

## 5. 测试计划（必须包含）
### 单元测试
- 目标：`mapService`、`aiService`、`shareService`。
- 建议框架：`vitest`。

### 接口测试
- 目标：路由层响应结构与状态码。
- 建议工具：`supertest`。

### Mock 覆盖
- 在 `MOCK_MODE=true` 下跑全套接口测试。

### 命令建议（由 Codex 在 Step 1 中新增）
- `npm run test`：运行单元 + 接口测试。
- `npm run test:watch`：本地开发快速回归。
- `npm run test:mock`：Mock 模式下的接口验证。

## 6. 验收标准
- 所有接口在 `MOCK_MODE=true` 下可用。
- 前端页面可完成完整演示流程。
- 测试通过，`/health` 正常返回。

## 7. 备注
当前版本以演示效果优先，真实数据与模型接入可在比赛后续版本逐步替换。
